---
title: "PhilTrans Paper"
author: "Erik Gjesfjeld"
date: "May 12, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Pilot Research for Philosophical Transactions B Paper  

### Due May 28 - Extension Possible? - Eva Boon (Guest Editor)

### Background on Manuscript

The research was originally discussed after a session at the HBES meetings in 2016 and then discussed again after the cultural evolution workshop last year in Leiden. The idea was fairly straight forward, to take a generative model of cultural change and estimate the origination and extinction rates under different model settings. In other words, this work represents a sort of sensitivity analysis of macro-evolutionary measures of micro-evolutionary dynamics. The model considered here contains the following parameters:

* $t_{max}$: defines number of time steps $[0:t_{max}]$
* $N$: population size, $N1$ = Starting pop size; $N2$ = Ending pop size
* $mu$: the mutation rate
* $b$: the strength of frequency-dependent selection ($b<0$ anti-conformity; $b=0$ neutral evolution; $b>0$ conformity)
* $c_b$: the commonness threshold that a variant has to meet to be supported by the bias
* $r$: the fraction of the population to be replaced in each time step

The model of cultural change proceeds by assuming initially that there are $N(0)$ cultural variants from a different type. Then, some cultural variants are chosen randomly $u(t)$ and removed from the population according to the $r$ parameter. Following this, cultural variants are added back into the population according to a given probability. 

A burn-in period of 500 time steps is automatically established for parameters to be kept constant and for the cultural system to reach stationarity. After, the burn-in period these previous steps are repeated for the $t_{max}$ steps and record the frequencies of all variant types at time $t$, $t=1,....,t_{max}$.  

Broadly, three analytical categories were established with the following parameters:

Default values:  
$t_{max}=50$  
$c_b = 0.3$  
$r = 0.3$  

***Analysis 1: Constant Population Size; Constant Transmission***

$N=[100,1000]$  
$\mu=[0.01,0.1]$  
$b=[-0.03,-0.01,0,0.01,0.03]$  

***Analysis 2: Changing Population Size; Constant Transmission***

$N(0),N(t_{max}) = [(100,500), (500,100), (1000,5000), (5000,1000)]$  
$\mu=[0.01,0.1]$  
$b=[-0.03,-0.01,0,0.01,0.03]$  

***Analysis 3: Constant Population Size; Changing Transmission***

$N=[100,1000]$   
$\mu=[0.01,0.1]$  
$b=[(-0.03,-0.01),(-0.03,0),(-0.03,0.01),(-0.03,0.03),(-0.01,-0.03),(-0.01,0),(-0.01,0.01),(-0.01,0.03),(0,-0.03),(0,-0.01),\\(0,0.01),(0,0.03),(0.01,-0.03),(0.01,-0.01),(0.01,-0.03),(0.03,-0.03),(0.03,-0.01),(0.03,0),(0.03,0.01)]$  

In total, these three analyses produce 140 different parameter settings. Initially, population sizes of 10,000 were also included in Analysis 1 and 3, but these resulting files sizes were extremely large (>20 GB) for some parameter settings and difficult to analyze with the existing computing power.  

### Key Research Questions

The research originated as a largely inductive exploration of how different parameter settings of a "micro-evolutionary" model of cultural change can be identified using "macroevolutionary" measures. Based on this, the following research questions guided this initial work:

1. **What is the best way to measure changes in the diversity of frequency data through time?  **    

    Broadly speaking, three different approaches are evaluated here: These are:
    * *Diversity Indices*: This includes measures taken directly from the frequency data for each time step. These include richness (count) of types, coefficient of variation, Simpson Diversity, and Shannon Diverity. 
    * *Rate estimation using variants*: This used the PyRate program to estimate rates of origination, extinction, net diverisification, and longevity. In this analysis, the occurrence of different types is weighted by their number of variants in each time step. In other words, types with more variants will be considered more popular and have more occurrences of that type in each time step.   
    * *Rate estimation (types only)*: This uses a modified version of PyRate, known as LiteRate, to estimate rates of origination, extinction, net diversification, and longevity only using the richness of types in each time step. In this process, the number of variants within each type does not impact how frequently it occurs, as each type only occurs once in each time step. 
    
2. **How are each of these diversity measures impacted by different parameters of the cultural change model? Are certain diversity measures more sensitive to population size, mutation rate, or changes in the cultural transmission process?  **   

    This is a question linked with first question as to whether certain macro-evolutionary measure pick up different aspects of the model of cultural change. To be honest, there are some broad conclusions that can be likely made, but specific insights might be more difficult.  
    
    
3. **Can the same dynamics be inferred between methods that incorporate the abundance of variants (PyRate) and those that simply examine the richness of types (LiteRate)?  **

    This is a question that I find very interesting and something that comes up often in macro-evolutionary research. Do we actually need to have high-resolution frequency data on the number of variants (or pottery styles for instance). Or, do we still get the same general picture of diversification if we just count the number of types (or pottery traditions or types). Furthermore, under what conditions can we just use the richness of types (and/or the estimation of their rates) as an approriate proxy for the diversification dynamics.   
    
    
### Preliminary Results

#### Example from Analysis 1
####  N1 = 1000 - N2 = 1000, mu = 0.1

```{r,warning=FALSE,echo=FALSE,eval=TRUE}
#If changes need to be made, adjust the A1_1000_Panel_Plots.R script and resave the .RData file
load("~/Dropbox/Cult_Change_Erik/A1_1000/A1_1000_Panel_Plots_12.RData")
```

```{r,fig.height=13,fig.width=13,echo=FALSE,warning=FALSE,message=FALSE,eval=TRUE}
library(gridExtra)
#png("~/Dropbox/Cult_Change_Erik/A1_100/A1_100_0.01_12_panel.png",units = "in", width = 20,height = 12,res=300)
grid.arrange(A1_1000_mu_0.1_raw_div,
             A1_1000_mu_0.1_CV,
             A1_1000_mu_0.1_Simpson,
             A1_1000_mu_0.1_Shannon,
             A1_1000_sp_mu_0.1,
             A1_1000_ex_mu_0.1,
             A1_1000_mu_0.1_net,
             A1_1000_mu_0.1_long,
             A1_1000_sp_mu_0.1_Lite,
             A1_1000_ex_mu_0.1_Lite,
             A1_1000_net_mu_0.1_Lite,
             A1_1000_long_mu_0.1_Lite,
             nrow = 3, name = "A1_1000_0.1")
```

#### Examples from Analysis 2
#### N1 = 1000 - N2 = 5000, mu = 0.1

```{r,warning=FALSE,echo=FALSE,eval=TRUE}
#If changes need to be made, adjust the A1_1000_Panel_Plots.R script and resave the .RData file
load("~/Dropbox/Cult_Change_Erik/A2_1000/A2_1000_Panel_Plots_12.RData")
```

```{r,fig.height=13,fig.width=13,echo=FALSE,warning=FALSE,message=FALSE,eval=TRUE}
grid.arrange(A2_1000_mu_0.1_raw_div_1000,
             A2_1000_mu_0.1_CV_1000,
             A2_1000_mu_0.1_Simpson_1000,
             A2_1000_mu_0.1_Shannon_1000,
             A2_1000_sp_mu_0.1_1000,
             A2_1000_ex_mu_0.1_1000,
             A2_1000_net_mu_0.1_1000,
             A2_1000_long_mu_0.1_1000,
             A2_1000_sp_mu_0.1_1000_Lite,
             A2_1000_ex_mu_0.1_1000_Lite,
             A2_1000_net_mu_0.1_1000_Lite,
             A2_1000_long_mu_0.1_1000_Lite,
             nrow = 3)
```

#### N1 = 5000 - N2 = 1000, mu = 0.1

```{r,warning=FALSE,echo=FALSE,eval=TRUE}
#If changes need to be made, adjust the A1_1000_Panel_Plots.R script and resave the .RData file
load("~/Dropbox/Cult_Change_Erik/A3_1000/A3_1000_.1/A3_1000_0.1_Panel_Plots_12.RData")
```

```{r,fig.height=13,fig.width=13,echo=FALSE,warning=FALSE,message=FALSE,eval=TRUE}
grid.arrange(A2_1000_mu_0.1_raw_div_5000,
             A2_1000_mu_0.1_CV_5000,
             A2_1000_mu_0.1_Simpson_5000,
             A2_1000_mu_0.1_Shannon_5000,
             A2_1000_sp_mu_0.1_5000,
             A2_1000_ex_mu_0.1_5000,
             A2_1000_net_mu_0.1_5000,
             A2_1000_long_mu_0.1_5000,
             A2_1000_sp_mu_0.1_5000_Lite,
             A2_1000_ex_mu_0.1_5000_Lite,
             A2_1000_net_mu_0.1_5000_Lite,
             A2_1000_long_mu_0.1_5000_Lite,
             nrow = 3)
```

#### Examples from Analysis 3
#### N1 = 1000 - N2 = 1000, mu = 0.1, b1 = -0.03, b2 = [-0.01, 0, 0.01, 0.03] 
#### Change at time step 25

```{r,fig.height=13,fig.width=13,echo=FALSE,warning=FALSE,message=FALSE,eval=TRUE}
grid.arrange(A3_1000_mu_0.1_raw_div_neg_.3,
             A3_1000_mu_0.1_CV_neg_.3,
             A3_1000_mu_0.1_Simpson_neg_.3,
             A3_1000_mu_0.1_Shannon_neg_.3,
             A3_1000_sp_mu_0.1_neg_.3,
             A3_1000_ex_mu_0.1_neg_.3,
             A3_1000_net_mu_0.1_neg_.3,
             A3_1000_long_mu_0.1_neg_.3,
             A3_1000_sp_mu_0.1_neg_.3_Lite,
             A3_1000_ex_mu_0.1_neg_.3_Lite,
             A3_1000_net_mu_0.1_neg_.3_Lite,
             A3_1000_long_mu_0.1_neg_.3_Lite,
             nrow = 3)
```

#### N1 = 1000 - N2 = 1000, mu = 0.1, b1 = 0.03, b2 = [-0.03, -0.01, 0, 0.01] 
#### Change at time step 25

```{r,fig.height=13,fig.width=13,echo=FALSE,warning=FALSE,message=FALSE,eval=TRUE}
grid.arrange(A3_1000_mu_0.1_raw_div_.3,
             A3_1000_mu_0.1_CV_.3,
             A3_1000_mu_0.1_Simpson_.3,
             A3_1000_mu_0.1_Shannon_.3,
             A3_1000_sp_mu_0.1_.3,
             A3_1000_ex_mu_0.1_.3,
             A3_1000_net_mu_0.1_.3,
             A3_1000_long_mu_0.1_.3,
             A3_1000_sp_mu_0.1_.3_Lite,
             A3_1000_ex_mu_0.1_.3_Lite,
             A3_1000_net_mu_0.1_.3_Lite,
             A3_1000_long_mu_0.1_.3_Lite,
             nrow = 3)
```

### Preliminary Conclusions

Apologies for the scale of these plots, I can provide larger and higher resolution ones if necessary. In addition, these are just a few examples, I have plots for all 140 different parameter settings if necessary. 

* ***Analysis 1*** Stationarity is generally achieved under constant transmission and constant population size. There are often some edge effects in time steps 50 and 1 (which have been removed here). This is largely because I forgot to turn on the setting to remove this time bin during the analysis. As a note, this is a much better result that our attempts at this project three years ago, when PyRate / LiteRate estimates were extremely variable. Since this time, both these methods have a different and much better MCMC algorithm implemented, specifically a RJMCMC as opposed to a Birth-Death MCMC.  

* ***Analysis 2*** Diversity indices (Row 1) all appear to be sensitive to differences in population sizes and the resulting changes in type and variant diversity. However, they are clearly impacted by the magnitude of the differences in diversity. In particular, a lower strength of frequency-dependent selection generally leads to a more rapid increase in overall richness when population rises, and more severe decline in richness when population declines. This rapid increase or decrease has clear impacts on diversity indices with Simpson and Shannon diversity providing significantly higher diversity values for lower frequency-dependent values (-0.03, -0.01, 0). Coefficient of variation (sd/mean) seems to be influenced by higher values of frequency-dependent selection (0.01, 0.03) indicating greater dispersion in these scenarios.  

* ***Analysis 2*** Rates of origination, extinction, net diversification (Origination - Extinction), and longevity (1 / extinction), all remain stable when the frequency-dependent selection variable remains stable, irregardless of population size changes. This is most indicative when population sizes increase or decrease the richness increases or decreases linearly. When population sizes are increasing, origination rates always remain higher then extinction rates (as expected), and net diversification rates always remain positive. When population sizes decrease, extinction rates for each value of $b$ are always higher then their corresponding origination rate. Once again, this is expected and net diversification rates are always negative in the situations. As a note, the graphs above for net diversification often have very small scales, accentuating pretty small differences in origination and extinction in the plots shown above.  

* ***Analysis 3*** Changing the frequency dependent strength of selection radically changes all measures used in this study. When moving from anti-conformity ($b=-0.03$) to higher levels of conformity, diversity declines across the board. Interestingly, origination rates and extinction rates both increase whenever moving from anti-conformity to conformity. However, the overall decline in diversity is driven by a greater increase in the extinction rate relative to the also increasing origination rate. It also appears that the most radical scenario ($b=-0.03$ to $b=0.03$) may take the longest time to re-stabilize and may not be captured in our 25 time steps. A similar pattern can also be recognized when moving from strong frequency dependent selection to lower values. Here, both origination and extinction rates decline quickly, with the exception of moveing from strong to moderate frequency dependent selection, i.e. $b1=0.03, b2=0.01$. The extinction rates also appear to decline more quickly and stabilize at a lower value, meaning the total net diversification remains positive.  

### Research Questions Revised

1. **What is the best way to measure changes in the diversity of frequency data through time?  **  

    There isn't a definitive answer to this question as different diversity measures pick up different aspects of the data (i.e. Question 2). Calculating rates definitely removes much of the noise (as is the goal of PyRate / LiteRate) and does not appear to be strongly influenced by the linear increase or decrease of richness due to population changes. I suppose this could be argued as a positive, since we often have poor estimates of population size, or a negative, as we want to know whether changes in population may have had a significant influence on rates. However, diversity indices are strongly influnced by population differences.   
    
2. **How are different diversity measures impacted by different parameters? **

    As highlighted above, diversity indices and diversification rates do highlight different aspects of the diversification history. What isn't presented here is the second part of the PyRate / LiteRAte analysis which identifies statistically signficant shift points in the origination and extinction rates. This is one of the main difficulties with using diversity indices, it can be hard to develop conclusions on whether a small increase or decrease is signficant. These results can easily be added in if necessary.  
    
3. **Can the same dynamics be inferred between methods using rates that estimate based on abundances of types and those that just use types?**

    This can be examined by looking at the differences between rows 2 and 3 in each of the plots. In almost all cases, the general trend of the rates is the same for both analyses. There are some differences in the exact rate values but the trends are nearly identitical. This is at least suggestive that when using rates as a diversification measure, weighting the types by the number of variants produces only minor benefits, such as decrease rate uncertainty.  
    

### Future Directions and Lingering Questions

1. Where does this research go from here and is there enough here to write a paper for PhilTrans?

    Right now, these results seem to interesting, but certainly not ground-breaking results. Are there key concepts or questions that should be considered in this that currently are not? This might include sampling type / variant data and running the same analysis to explore what an "archaeological" sample might look like. Or, the inclusion of identifying statistically significant shift points in rates, something that is available when using diversity indices.Or possibly running the analysis much longer? 50 time steps was chosen as this seemed like a more realistic archaeological number as opposed to 500 or 1000 time steps.   
    
2. What does this actually tell us about cultural transmission? 

    The results presented here are more informative of how we measure diversity at different scales rather than providing insights into cultural transmission processes and patterns. Based on these results, what can we say about frequency-dependent selection that hasn't already been discussed in other papers?  
    
3. Micro vs. Macro

    One of the points that the editors wanted us to explore was the relationship between micro and macro evolution. What aspects of this work are relevant to this broader discussion?  
